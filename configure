#!/bin/bash -x

# configure script that will fetch and build SimpleITK, then move the results
# to somewhere that R can install. It takes a long time and uses
# a substantial amount of disk space
#
# Requires git and cmake
#
# This script has 3 functions
# 1) Fetch all the dependencies using git and build. For use with devtools or a local install.
# 2) Create a source package for CRAN by performing step 1 and cleaning up after.
# 3) Build the source package from CRAN.
#
# The main differences between the functionality is captured in the sitkmove.R script.
#

export SimpleITKGit=https://github.com/SimpleITK/SimpleITK
export SITKTAG=v1.1.0
export SITKTAG=f7debf94174f69960d5b47e34a6b9397a53c6770

export PKGBASED=$(pwd)
echo ${PKGBASED}

## make sure we've got the correct R
[ -z "$R_HOME" ] &&  echo "Environment variable \"R_HOME\" is not set!" && exit 1
RCALL="${R_HOME}/bin/R"
export RCALL

CC="$(${RCALL} CMD config CC)"
CXX="$(${RCALL} CMD config CXX)"
CFLAGS="$(${RCALL} CMD config CFLAGS)"
CXXFLAGS="$(${RCALL} CMD config CXX1XFLAGS)"
CPPFLAGS="$(${RCALL} CMD config CPPFLAGS)"
export CXX
export CC
export CXXFLAGS
export CPPFLAGS
export CFLAGS

## Level of parallel build
## Don't use the Ncpus option for install.packages because it
## refers to multiple packages
if [ -z "${MAKEJ}" ] ; then
    MAKEJ=1
    export MAKEJ
fi

## All the building is going to happen in an SITK folder
SITKSRCDIR=src/SITK
export SITKSRCDIR
mkdir -p ${SITKSRCDIR}

FULLSOURCE=0
[ -d ${SITKSRCDIR}/SimpleITK ] && FULLSOURCE=1
export FULLSOURCE
echo $FULLSOURCE

# if we are in a full source package then we don't need to download
# manuals or test images
FORBID_DOWNLOADS=
[ ${FULLSOURCE} = 1 ] && FORBID_DOWNLOAD="-DSITK_FORBID_DOWNLOADS=ON"
export FORBID_DOWNLOADS

(
    cd ${SITKSRCDIR} &&
    [ -d SimpleITK ] ||
      ( git clone  ${SimpleITKGit} &&
          cd SimpleITK &&
          git checkout  ${SITKTAG} ) || exit 1

    mkdir -p Build &&
    cd Build &&
    cmake \
        -DWRAP_DEFAULT=OFF\
        -DWRAP_R=ON \
        -DBUILD_EXAMPLES=OFF \
        ${FORBID_DOWNLOADS} \
        -DBUILD_TESTING=OFF \
        ../SimpleITK/SuperBuild/ ||
    exit 1

    #echo "Parallel build using -j${MAKEJ}"
    #make -j${MAKEJ} &&
    # Use R to do the move to avoid system specific issues.
    #${RCALL} -f ${PKGBASED}/sitkmove.R --args SimpleITK-build/Wrapping/R/Packaging/SimpleITK/ ${PKGBASED} ${FULLSOURCE} ||
    #exit 1


)
